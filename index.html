<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-dark: #27ae60;
            --warning-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-color: #fff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
        }

        h1, h2, h3, h4 {
            color: #2c3e50;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-color);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .welcome-screen, .setup-screen, .quiz-screen, .results-screen {
            display: none;
        }

        .welcome-screen.active, .setup-screen.active, .quiz-screen.active, .results-screen.active {
            display: block;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-direct-upload {
            display: block;
            margin-top: 15px;
            background-color: #95a5a6;
        }

        .btn-direct-upload:hover {
            background-color: #7f8c8d;
        }

        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
        }

        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .question-container {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--primary-color);
        }

        .answer-container {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid var(--secondary-color);
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 20px 0;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--primary-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .round-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .round-summary {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .topic-selector {
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .file-name {
            margin-top: 10px;
            font-style: italic;
        }

        .error-message {
            color: var(--warning-color);
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            display: none;
        }

        .success-message {
            color: #27ae60;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background-color: #d5f5e3;
            border-radius: 4px;
            display: none;
        }

        .json-preview {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 15px 0;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .score-display {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }

        .loading:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        .or-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #777;
        }

        .or-divider:before,
        .or-divider:after {
            content: "";
            flex-grow: 1;
            background: #ddd;
            height: 1px;
            margin: 0 10px;
        }

        .debug-panel {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }

        textarea.json-input {
            width: 100%;
            height: 200px;
            font-family: monospace;
            padding: 10px;
            margin-top: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div class="welcome-screen active card">
            <h1>Generic Quiz App</h1>
            <p>Welcome to the Quiz! This application allows you to test your knowledge on various topics.</p>
            
            <div class="upload-container">
                <button class="btn" id="uploadButton">Upload Quiz Data (JSON)</button>
                <input type="file" id="fileInput" class="file-input" accept=".json">
                <p class="file-name" id="fileName"></p>
                <div class="json-preview" id="jsonPreview"></div>
            </div>
            
            <div class="or-divider">OR</div>
            
            <button class="btn" id="useSampleButton">Use Sample Data</button>
            
            <div class="or-divider">OR</div>
            
            <button class="btn btn-direct-upload" id="showJsonInputButton">Paste JSON Data Directly</button>
            <div id="jsonInputContainer" style="display: none;">
                <textarea class="json-input" id="jsonInputArea" placeholder='Paste your JSON data here...'></textarea>
                <button class="btn" id="loadJsonButton">Load Data</button>
            </div>
            
            <div class="loading" id="loadingIndicator">Loading quiz data</div>
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <div class="debug-panel" id="debugPanel" style="display: none;">
                <h4>Debug Information</h4>
                <div id="debugInfo"></div>
            </div>
        </div>

        <!-- Setup Screen -->
        <div class="setup-screen card">
            <h2>Quiz Setup</h2>
            
            <div class="topic-selector">
                <label for="topicSelect">Select Topic:</label>
                <select id="topicSelect">
                    <!-- Will be populated with topics from JSON -->
                </select>
            </div>
            
            <div>
                <label for="roundsInput">Number of Rounds:</label>
                <input type="number" id="roundsInput" min="1" max="10" value="3">
            </div>
            
            <div>
                <label for="questionsPerRoundInput">Questions per Round:</label>
                <input type="number" id="questionsPerRoundInput" min="1" max="20" value="5">
            </div>
            
            <p id="availableQuestions">Available questions: 0</p>
            
            <button class="btn" id="startQuizButton">Start Quiz</button>
            <button class="btn" id="backToWelcomeButton" style="background-color: #95a5a6;">Back</button>
        </div>

        <!-- Quiz Screen -->
        <div class="quiz-screen card">
            <div class="round-info">
                <span id="currentRoundDisplay">Round 1</span>
                <span id="questionCountDisplay">Question 1/5</span>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="question-container">
                <h3 id="questionText">Question goes here</h3>
                <button class="btn btn-secondary" id="showAnswerButton">Show Answer</button>
                <div class="answer-container" id="answerContainer">
                    <p id="answerText">Answer goes here</p>
                </div>
            </div>
            
            <button class="btn" id="nextQuestionButton">Next Question</button>
            <button class="btn" id="finishRoundButton" style="display: none;">Finish Round</button>
        </div>

        <!-- Round Results Screen -->
        <div class="results-screen card" id="roundResults">
            <h2 id="roundResultsTitle">Round X Results</h2>
            
            <div id="roundSummary" class="round-summary">
                <!-- Will be populated with round summary -->
            </div>
            
            <button class="btn" id="nextRoundButton">Next Round</button>
            <button class="btn" id="finishQuizButton" style="display: none;">Finish Quiz</button>
        </div>

        <!-- Final Results Screen -->
        <div class="results-screen card" id="finalResults">
            <h2>Quiz Completed!</h2>
            
            <div class="score-display" id="finalScore">
                <!-- Will show final score -->
            </div>
            
            <button class="btn" id="restartQuizButton">Start New Quiz</button>
        </div>
    </div>

    <script>
        // App State
        let quizData = null;
        let selectedTopic = '';
        let rounds = 3;
        let questionsPerRound = 5;
        let currentRound = 0;
        let currentQuestion = 0;
        let roundQuestions = [];
        let allRoundQuestions = [];
        let answeredQuestions = 0;
        let debugMode = true; // Set to true to show debug information
        
        // DOM Elements
        const welcomeScreen = document.querySelector('.welcome-screen');
        const setupScreen = document.querySelector('.setup-screen');
        const quizScreen = document.querySelector('.quiz-screen');
        const roundResultsScreen = document.getElementById('roundResults');
        const finalResultsScreen = document.getElementById('finalResults');
        
        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const jsonPreview = document.getElementById('jsonPreview');
        const useSampleButton = document.getElementById('useSampleButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const debugPanel = document.getElementById('debugPanel');
        const debugInfo = document.getElementById('debugInfo');
        
        const showJsonInputButton = document.getElementById('showJsonInputButton');
        const jsonInputContainer = document.getElementById('jsonInputContainer');
        const jsonInputArea = document.getElementById('jsonInputArea');
        const loadJsonButton = document.getElementById('loadJsonButton');
        
        const topicSelect = document.getElementById('topicSelect');
        const roundsInput = document.getElementById('roundsInput');
        const questionsPerRoundInput = document.getElementById('questionsPerRoundInput');
        const availableQuestions = document.getElementById('availableQuestions');
        const startQuizButton = document.getElementById('startQuizButton');
        const backToWelcomeButton = document.getElementById('backToWelcomeButton');
        
        const currentRoundDisplay = document.getElementById('currentRoundDisplay');
        const questionCountDisplay = document.getElementById('questionCountDisplay');
        const progressBar = document.getElementById('progressBar');
        const questionText = document.getElementById('questionText');
        const showAnswerButton = document.getElementById('showAnswerButton');
        const answerContainer = document.getElementById('answerContainer');
        const answerText = document.getElementById('answerText');
        const nextQuestionButton = document.getElementById('nextQuestionButton');
        const finishRoundButton = document.getElementById('finishRoundButton');
        
        const roundResultsTitle = document.getElementById('roundResultsTitle');
        const roundSummary = document.getElementById('roundSummary');
        const nextRoundButton = document.getElementById('nextRoundButton');
        const finishQuizButton = document.getElementById('finishQuizButton');
        
        const finalScore = document.getElementById('finalScore');
        const restartQuizButton = document.getElementById('restartQuizButton');
        
        // Sample Data for testing
        const sampleData = {
            "ACCIDENTS": [
                {
                    "number": "1",
                    "question": "What is an Accident?",
                    "answer": "It is an unplanned happening."
                },
                {
                    "number": "2",
                    "question": "What is an 'incident'?",
                    "answer": "An incident is an unplanned event with the potential to lead to an accident."
                },
                {
                    "number": "3",
                    "question": "What is a 'hazard'?",
                    "answer": "A hazard is anything with the potential to cause harm."
                },
                {
                    "number": "4",
                    "question": "Why remove your gloves before you remove your goggles?",
                    "answer": "To prevent contamination of the face or eyes by a substance or substances that are on your gloves."
                },
                {
                    "number": "5",
                    "question": "Is running a suitable pace for a factory or workshop?",
                    "answer": "No. - You should always walk."
                },
                {
                    "number": "6",
                    "question": "Give two reasons for not piling a trolley high with goods?",
                    "answer": "1. Obscures Vision 2. Unstable. 3. May cause back strain."
                },
                {
                    "number": "7",
                    "question": "Should accident prevention be left to the Safety Manager as the representative of management, and the supervisory staff in a place of work?",
                    "answer": "No - It is the responsibility of all concerned in the workplace."
                },
                {
                    "number": "8",
                    "question": "Has a Safety Officer or Safety Manager a responsibility to see that Safety measures are complied with?",
                    "answer": "Yes - As an agent of management with delegated responsibility."
                }
            ],
            "FIRE/EMERGENCY PLANNING": [
                {
                    "number": "1",
                    "question": "Give two sources of fire?",
                    "answer": "1. Sparks 2. Flames. 3. Hot Surfaces. 4. Radiant Heat."
                },
                {
                    "number": "2",
                    "question": "Name the elements that comprise the triangle of fire?",
                    "answer": "Fuel, Heat, and Oxygen."
                },
                {
                    "number": "3",
                    "question": "Name two means by which heat may be transmitted and result in a spread of fire?",
                    "answer": "Radiation, Conduction, and Convection."
                },
                {
                    "number": "4",
                    "question": "A flammable vapour or gas will only ignite or explode in air if the Air:Fuel ratio is in the correct proportions. How are these limits normally expressed?",
                    "answer": "1. L.E.L. - Lower Explosive Limit. 2. U.E.L. - Upper Explosive Limit."
                },
                {
                    "number": "5",
                    "question": "Give two requirements regarding fire exits?",
                    "answer": "1. Clearly Marked. 2. Open Outwards or Slide. 3. Be Kept Clear. 4. Be Always Available."
                },
                {
                    "number": "6",
                    "question": "Name two types of security fastenings acceptable on fire exit doors?",
                    "answer": "1. Panic Bolts. 2. Panic Latches. 3. Alarm Locks. 4. Glass Bolts. 5. Ordinary Ball Catches."
                },
                {
                    "number": "7",
                    "question": "What type of extinguisher is best suited to free flowing liquid fires?",
                    "answer": "Dry Powder."
                },
                {
                    "number": "8",
                    "question": "How do dry powder extinguishers extinguish fires?",
                    "answer": "By stopping chain flame reaction and smothering."
                }
            ],
            "FIRST AID": [
                {
                    "number": "1",
                    "question": "What is the initial first aid treatment for acid burns?",
                    "answer": "Flood the area with slowly running water for 20 minutes. Gently remove contaminated clothing while flooding the area."
                },
                {
                    "number": "2",
                    "question": "What are the two primary objectives of First Aid treatment?",
                    "answer": "Sustain life Prevent a situation from becoming worse Promote recovery."
                },
                {
                    "number": "3",
                    "question": "Who must be in charge of a First Aid box?",
                    "answer": "A responsible or trained person."
                },
                {
                    "number": "4",
                    "question": "What special warning would you give to a casualty with suspected spinal injuries?",
                    "answer": "Not to attempt to get up or move."
                },
                {
                    "number": "5",
                    "question": "What must a first aider always treat for and why?",
                    "answer": "Shock - Shock can prove fatal unless measures are taken to counteract it."
                },
                {
                    "number": "6",
                    "question": "Under what circumstances is it permissible to move a seriously injured person?",
                    "answer": "If there is further danger by leaving them where they are."
                },
                {
                    "number": "7",
                    "question": "Where is the Humerus?",
                    "answer": "In the upper arm."
                },
                {
                    "number": "8",
                    "question": "Where is the Radius?",
                    "answer": "In the forearm."
                }
            ]
        };
        
        // Helper Functions
        function log(message) {
            if (debugMode) {
                console.log(message);
                debugPanel.style.display = 'block';
                debugInfo.innerHTML += `<div>${message}</div>`;
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            loadingIndicator.style.display = 'none';
            log(`ERROR: ${message}`);
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            log(`SUCCESS: ${message}`);
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('App initialized');
            
            // Initial setup
            uploadButton.addEventListener('click', () => {
                log('Upload button clicked');
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (event) => {
                log('File input changed');
                handleFileUpload(event);
            });
            
            useSampleButton.addEventListener('click', () => {
                log('Use sample button clicked');
                useSampleData();
            });
            
            showJsonInputButton.addEventListener('click', () => {
                log('Show JSON input button clicked');
                jsonInputContainer.style.display = jsonInputContainer.style.display === 'none' ? 'block' : 'none';
            });
            
            loadJsonButton.addEventListener('click', () => {
                log('Load JSON button clicked');
                loadJsonData();
            });
            
            startQuizButton.addEventListener('click', () => {
                log('Start quiz button clicked');
                startQuiz();
            });
            
            backToWelcomeButton.addEventListener('click', () => {
                log('Back button clicked');
                setupScreen.classList.remove('active');
                welcomeScreen.classList.add('active');
            });
            
            showAnswerButton.addEventListener('click', () => {
                log('Show answer button clicked');
                showAnswer();
            });
            
            nextQuestionButton.addEventListener('click', () => {
                log('Next question button clicked');
                nextQuestion();
            });
            
            finishRoundButton.addEventListener('click', () => {
                log('Finish round button clicked');
                finishRound();
            });
            
            nextRoundButton.addEventListener('click', () => {
                log('Next round button clicked');
                startNextRound();
            });
            
            finishQuizButton.addEventListener('click', () => {
                log('Finish quiz button clicked');
                showFinalResults();
            });
            
            restartQuizButton.addEventListener('click', () => {
                log('Restart quiz button clicked');
                restartQuiz();
            });
            
            // Update available questions when topic changes
            topicSelect.addEventListener('change', () => {
                log('Topic changed');
                updateAvailableQuestions();
            });
            
            // Update max values when rounds or questions per round change
            roundsInput.addEventListener('change', validateInputs);
            questionsPerRoundInput.addEventListener('change', validateInputs);
        });
        
        // Functions
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                log('No file selected');
                return;
            }
            
            fileName.textContent = file.name;
            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            log(`File selected: ${file.name} (${file.size} bytes)`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonText = e.target.result;
                    log(`File content loaded (${jsonText.length} characters)`);
                    
                    // Preview the JSON
                    jsonPreview.textContent = jsonText.length > 500 ? 
                        jsonText.substring(0, 500) + '...' : 
                        jsonText;
                    jsonPreview.style.display = 'block';
                    
                    try {
                        quizData = JSON.parse(jsonText);
                        log('JSON parsed successfully');
                        setupQuiz();
                    } catch (err) {
                        showError(`Error parsing JSON: ${err.message}`);
                        log(`JSON parse error: ${err.message}`);
                    }
                } catch (err) {
                    showError(`Error reading file: ${err.message}`);
                    log(`File read error: ${err.message}`);
                }
                loadingIndicator.style.display = 'none';
            };
            
            reader.onerror = function() {
                showError("Error reading file.");
                loadingIndicator.style.display = 'none';
                log('File read error in FileReader');
            };
            
            reader.readAsText(file);
        }
        
        function loadJsonData() {
            const jsonText = jsonInputArea.value.trim();
            if (!jsonText) {
                showError("Please enter JSON data.");
                return;
            }
            
            log(`Direct JSON input (${jsonText.length} characters)`);
            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            try {
                quizData = JSON.parse(jsonText);
                log('JSON parsed successfully from direct input');
                setupQuiz();
                showSuccess("JSON data loaded successfully!");
            } catch (err) {
                showError(`Error parsing JSON: ${err.message}`);
                log(`JSON parse error: ${err.message}`);
            }
            
            loadingIndicator.style.display = 'none';
        }
        
        function useSampleData() {
            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            log('Using sample data');
            
            // Simulate loading
            setTimeout(() => {
                quizData = JSON.parse(JSON.stringify(sampleData)); // Deep copy
                log('Sample data loaded');
                setupQuiz();
                showSuccess("Sample data loaded successfully!");
                loadingIndicator.style.display = 'none';
            }, 500);
        }
        
        function setupQuiz() {
            // Populate topic dropdown
            topicSelect.innerHTML = '';
            
            const topics = Object.keys(quizData);
            log(`Found ${topics.length} topics in the quiz data`);
            
            if (topics.length === 0) {
                showError("No topics found in the quiz data.");
                return;
            }
            
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
                log(`Added topic: ${topic} with ${quizData[topic].length} questions`);
            });
            
            // Set default topic
            selectedTopic = topics[0];
            topicSelect.value = selectedTopic;
            
            // Update available questions count
            updateAvailableQuestions();
            
            // Show setup screen
            welcomeScreen.classList.remove('active');
            setupScreen.classList.add('active');
            showSuccess("Quiz data loaded successfully!");
        }
        
        function updateAvailableQuestions() {
            selectedTopic = topicSelect.value;
            const topicQuestions = quizData[selectedTopic] || [];
            availableQuestions.textContent = `Available questions: ${topicQuestions.length}`;
            
            log(`Selected topic: ${selectedTopic} with ${topicQuestions.length} questions`);
            
            // Update max values for inputs
            const maxRounds = Math.max(1, Math.floor(topicQuestions.length / questionsPerRound));
            roundsInput.max = maxRounds;
            if (parseInt(roundsInput.value) > maxRounds) {
                roundsInput.value = maxRounds;
            }
            
            const maxQuestionsPerRound = Math.min(20, topicQuestions.length);
            questionsPerRoundInput.max = maxQuestionsPerRound;
            if (parseInt(questionsPerRoundInput.value) > maxQuestionsPerRound) {
                questionsPerRoundInput.value = maxQuestionsPerRound;
            }
            
            log(`Updated inputs - Max rounds: ${maxRounds}, Max questions per round: ${maxQuestionsPerRound}`);
        }
        
        function validateInputs() {
            const topicQuestions = quizData[selectedTopic] || [];
            
            rounds = parseInt(roundsInput.value);
            questionsPerRound = parseInt(questionsPerRoundInput.value);
            
            log(`Validating inputs - Rounds: ${rounds}, Questions per round: ${questionsPerRound}`);
            
            // Ensure we don't exceed available questions
            const totalQuestions = rounds * questionsPerRound;
            if (totalQuestions > topicQuestions.length) {
                if (topicQuestions.length === 0) {
                    rounds = 0;
                    questionsPerRound = 0;
                } else if (questionsPerRound > topicQuestions.length) {
                    questionsPerRound = topicQuestions.length;
                    rounds = 1;
                } else {
                    rounds = Math.floor(topicQuestions.length / questionsPerRound);
                }
                
                roundsInput.value = rounds;
                questionsPerRoundInput.value = questionsPerRound;
                log(`Adjusted inputs - Rounds: ${rounds}, Questions per round: ${questionsPerRound}`);
            }
        }
        
        function startQuiz() {
            // Get values from inputs
            rounds = parseInt(roundsInput.value);
            questionsPerRound = parseInt(questionsPerRoundInput.value);
            
            // Validate inputs
            validateInputs();
            
            log(`Starting quiz - Rounds: ${rounds}, Questions per round: ${questionsPerRound}`);
            
            if (rounds <= 0 || questionsPerRound <= 0) {
                showError("Not enough questions available. Please select a different topic or reduce the number of rounds/questions.");
                return;
            }
            
            // Reset quiz state
            currentRound = 0;
            currentQuestion = 0;
            allRoundQuestions = [];
            answeredQuestions = 0;
            
            // Start the first round
            startRound();
            
            // Show quiz screen
            setupScreen.classList.remove('active');
            quizScreen.classList.add('active');
        }
        
        function startRound() {
            currentRound++;
            currentQuestion = 0;
            
            log(`Starting round ${currentRound} of ${rounds}`);
            
            // Get available questions for the topic
            const topicQuestions = [...quizData[selectedTopic]];
            
            // Remove already used questions
            const filteredQuestions = topicQuestions.filter(question => 
                !allRoundQuestions.some(q => q.number === question.number)
            );
            
            log(`Found ${filteredQuestions.length} unused questions`);
            
            // Randomly select questions for this round
            roundQuestions = [];
            for (let i = 0; i < questionsPerRound; i++) {
                if (filteredQuestions.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * filteredQuestions.length);
                roundQuestions.push(filteredQuestions[randomIndex]);
                filteredQuestions.splice(randomIndex, 1);
            }
            
            log(`Selected ${roundQuestions.length} questions for round ${currentRound}`);
            
            // Add to overall collection
            allRoundQuestions = [...allRoundQuestions, ...roundQuestions];
            
            // Update UI
            currentRoundDisplay.textContent = `Round ${currentRound} of ${rounds}`;
            loadQuestion();
        }
        
        function loadQuestion() {
            const question = roundQuestions[currentQuestion];
            
            log(`Loading question ${currentQuestion + 1}: ${question.question}`);
            
            // Update question text
            questionText.textContent = `${question.question}`;
            
            // Update answer text
            answerText.textContent = question.answer;
            
            // Hide answer
            answerContainer.style.display = 'none';
            showAnswerButton.style.display = 'block';
            
            // Update question count
            questionCountDisplay.textContent = `Question ${currentQuestion + 1}/${roundQuestions.length}`;
            
            // Update progress bar
            const progress = ((currentQuestion) / roundQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
            
            // Show/hide buttons
            nextQuestionButton.style.display = currentQuestion < roundQuestions.length - 1 ? 'block' : 'none';
            finishRoundButton.style.display = currentQuestion === roundQuestions.length - 1 ? 'block' : 'none';
        }
        
        function showAnswer() {
            log('Showing answer');
            answerContainer.style.display = 'block';
            showAnswerButton.style.display = 'none';
            answeredQuestions++;
        }
        
        function nextQuestion() {
            currentQuestion++;
            log(`Moving to question ${currentQuestion + 1}`);
            loadQuestion();
        }
        
        function finishRound() {
            log(`Finishing round ${currentRound}`);
            
            // Show round results screen
            quizScreen.classList.remove('active');
            roundResultsScreen.classList.add('active');
            
            // Update round results title
            roundResultsTitle.textContent = `Round ${currentRound} Results`;
            
            // Display all questions and answers for this round
            let summaryHTML = '';
            roundQuestions.forEach((question, index) => {
                summaryHTML += `
                    <div class="question-container">
                        <h3>${index + 1}. ${question.question}</h3>
                        <div class="answer-container" style="display: block;">
                            <p>${question.answer}</p>
                        </div>
                    </div>
                `;
            });
            
            roundSummary.innerHTML = summaryHTML;
            
            // Show appropriate buttons
            nextRoundButton.style.display = currentRound < rounds ? 'block' : 'none';
            finishQuizButton.style.display = currentRound === rounds ? 'block' : 'none';
        }
        
        function startNextRound() {
            log('Starting next round');
            roundResultsScreen.classList.remove('active');
            quizScreen.classList.add('active');
            startRound();
        }
        
        function showFinalResults() {
            log('Showing final results');
            // Show final results screen
            roundResultsScreen.classList.remove('active');
            finalResultsScreen.classList.add('active');
            
            // Display final score
            const totalQuestions = rounds * questionsPerRound;
            const scorePercentage = Math.round((answeredQuestions / totalQuestions) * 100);
            finalScore.textContent = `You viewed answers for ${answeredQuestions} out of ${totalQuestions} questions (${scorePercentage}%)`;
        }
        
        function restartQuiz() {
            log('Restarting quiz');
            // Reset to setup screen
            finalResultsScreen.classList.remove('active');
            setupScreen.classList.add('active');
            
            // Reset state
            currentRound = 0;
            currentQuestion = 0;
            allRoundQuestions = [];
            answeredQuestions = 0;
            
            // Update available questions
            updateAvailableQuestions();
        }